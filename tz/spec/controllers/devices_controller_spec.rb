require "rails_helper"

RSpec.describe DevicesController, :type => :controller do
  describe "POST #import" do
    let!(:file) { fixture_file_upload('files/data.csv', 'text/csv') }
    let!(:customer) { Customer.create() }
    let!(:business_account) { BusinessAccount.create(customer_id: customer.id, name: '01074132') }
    let!(:accounting_type1) { AccountingType.create(customer_id: customer.id, name: 'Reports To') }
    let!(:accounting_type2) { AccountingType.create(customer_id: customer.id, name: 'Cost Center') }
    let!(:acc_cat1) { AccountingCategory.create(accounting_type_id: accounting_type2.id, name: '10010.8350') }
    let!(:acc_cat2) { AccountingCategory.create(accounting_type_id: accounting_type2.id, name: '10083.8350') }
    let!(:acc_cat3) { AccountingCategory.create(accounting_type_id: accounting_type2.id, name: '26837.7037.18') }
    let!(:acc_cat4) { AccountingCategory.create(accounting_type_id: accounting_type1.id, name: '10010 Corporate Development') }
    let!(:acc_cat5) { AccountingCategory.create(accounting_type_id: accounting_type1.id, name: '10083 INT - International') }
    let!(:acc_cat6) { AccountingCategory.create(accounting_type_id: accounting_type1.id, name: '26837 Carson Wainwright') }
    before do
     controller.instance_variable_set(:@customer, customer)
     allow(controller).to receive(:current_user).and_return('current_user')
    end

    it "import data into Device" do
      post :import, import_file: file
      expect(response).to have_http_status(:ok)
      expect(flash[:notice]).to eq "Import successfully completed. 4 lines updated/added. 0 lines removed."
      expect(Device.all.to_a.map(&:serializable_hash)
                            .map{|l|l.reject{|k,_| ["updated_at", "created_at"].include?(k)}}
                            .to_json).to eq "[{\"id\":1,\"number\":\"5879814504\",\"customer_id\":1,\"business_account_id\":1074132,\"device_model_id\":0,\"device_make_id\":0,\"carrier_base_id\":\"Telus\",\"device_model_mapping_id\":null,\"carrier_rate_plan_id\":null,\"contact_id\":null,\"model_id\":null,\"model\":\"iPad Air 32GB\",\"heartbeat\":null,\"hmac_key\":null,\"hash_key\":null,\"additional_data\":null,\"deferred\":null,\"deployed_until\":null,\"transfer_token\":null,\"username\":\"Guy Number 1\",\"location\":\"Edmonton\",\"contract_expiry_date\":null,\"email\":null,\"inactive\":\"f\",\"in_suspension\":\"f\",\"is_roaming\":\"f\",\"imei_number\":\"\",\"sim_number\":\"8912230000293881017\",\"employee_number\":null,\"additional_data_old\":\"{\\\"accounting_categories_percentage\\\":[\\\"100\\\"],\\\"partial_accounting_categories\\\":null}\",\"added_features\":\"International Calling On, International Voice Roaming On, Corp Roam Intl Zone1\",\"current_rate_plan\":\"Cost Assure Data for Tablet\",\"data_usage_status\":\"unblocked\",\"transfer_to_personal_status\":\"not_transfered\",\"apple_warranty\":\"{}\",\"eligibility_date\":null,\"number_for_forwarding\":null,\"call_forwarding_status\":\"not_active\",\"asset_tag\":null,\"status\":\"active\"},{\"id\":2,\"number\":\"4038283663\",\"customer_id\":1,\"business_account_id\":1074132,\"device_model_id\":1,\"device_make_id\":1,\"carrier_base_id\":\"Telus\",\"device_model_mapping_id\":null,\"carrier_rate_plan_id\":null,\"contact_id\":null,\"model_id\":null,\"model\":\"6\",\"heartbeat\":null,\"hmac_key\":null,\"hash_key\":null,\"additional_data\":null,\"deferred\":null,\"deployed_until\":null,\"transfer_token\":null,\"username\":\"Guy Number 2\",\"location\":\"Calgary\",\"contract_expiry_date\":\"2018-10-07\",\"email\":null,\"inactive\":\"f\",\"in_suspension\":\"f\",\"is_roaming\":\"f\",\"imei_number\":\"359307063973495\",\"sim_number\":\"8912230000193245107\",\"employee_number\":\"231134\",\"additional_data_old\":\"{\\\"accounting_categories_percentage\\\":[\\\"100\\\"],\\\"partial_accounting_categories\\\":null}\",\"added_features\":\"Minutes 150, Corp Roam US Rates, International Data Roaming On\",\"current_rate_plan\":\"Corp $12.50 PCS Voice Plan\",\"data_usage_status\":\"unblocked\",\"transfer_to_personal_status\":\"not_transfered\",\"apple_warranty\":\"{}\",\"eligibility_date\":null,\"number_for_forwarding\":null,\"call_forwarding_status\":\"not_active\",\"asset_tag\":null,\"status\":\"active\"},{\"id\":3,\"number\":\"4038269268\",\"customer_id\":1,\"business_account_id\":1074132,\"device_model_id\":2,\"device_make_id\":1,\"carrier_base_id\":\"Telus\",\"device_model_mapping_id\":null,\"carrier_rate_plan_id\":null,\"contact_id\":null,\"model_id\":null,\"model\":\"5C\",\"heartbeat\":null,\"hmac_key\":null,\"hash_key\":null,\"additional_data\":null,\"deferred\":null,\"deployed_until\":null,\"transfer_token\":null,\"username\":\"Vacation Disconnect\",\"location\":\"Calgary\",\"contract_expiry_date\":\"2016-04-11\",\"email\":null,\"inactive\":\"f\",\"in_suspension\":\"t\",\"is_roaming\":\"f\",\"imei_number\":\"013838005788920\",\"sim_number\":\"8912230000147718936\",\"employee_number\":null,\"additional_data_old\":\"{\\\"accounting_categories_percentage\\\":[\\\"100\\\"],\\\"partial_accounting_categories\\\":null}\",\"added_features\":\"International Data Roaming\",\"current_rate_plan\":\"Corp $12.50 PCS Voice Plan\",\"data_usage_status\":\"unblocked\",\"transfer_to_personal_status\":\"not_transfered\",\"apple_warranty\":\"{}\",\"eligibility_date\":null,\"number_for_forwarding\":null,\"call_forwarding_status\":\"not_active\",\"asset_tag\":null,\"status\":\"suspended\"},{\"id\":4,\"number\":\"7808161381\",\"customer_id\":1,\"business_account_id\":1074132,\"device_model_id\":3,\"device_make_id\":2,\"carrier_base_id\":\"Telus\",\"device_model_mapping_id\":null,\"carrier_rate_plan_id\":null,\"contact_id\":null,\"model_id\":null,\"model\":\"LG A341\",\"heartbeat\":null,\"hmac_key\":null,\"hash_key\":null,\"additional_data\":null,\"deferred\":null,\"deployed_until\":null,\"transfer_token\":null,\"username\":\"Vacation Disconnect\",\"location\":\"Wainwright\",\"contract_expiry_date\":\"2016-04-11\",\"email\":null,\"inactive\":\"f\",\"in_suspension\":\"f\",\"is_roaming\":\"f\",\"imei_number\":\"352262051494995\",\"sim_number\":\"8912230000126768100\",\"employee_number\":null,\"additional_data_old\":\"{\\\"accounting_categories_percentage\\\":[\\\"100\\\"],\\\"partial_accounting_categories\\\":null}\",\"added_features\":\"Corp Roam Intl Zone2, Corp Roam US Rates,Corp - Unlimited text msg\",\"current_rate_plan\":\"Corp $12.50 PCS Voice Plan\",\"data_usage_status\":\"unblocked\",\"transfer_to_personal_status\":\"not_transfered\",\"apple_warranty\":\"{}\",\"eligibility_date\":null,\"number_for_forwarding\":null,\"call_forwarding_status\":\"not_active\",\"asset_tag\":null,\"status\":\"active\"}]"
    end
  end
end